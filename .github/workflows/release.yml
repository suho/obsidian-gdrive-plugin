name: Release plugin

on:
    push:
        tags:
            - "*"
            - "!beta"
            - "!beta-*"
    workflow_call:
        inputs:
            tag_name:
                description: Release tag to create.
                required: true
                type: string
            release_name:
                description: Optional release display name.
                required: false
                type: string
            prerelease:
                description: Mark release as prerelease.
                required: false
                default: false
                type: boolean
            generate_release_notes:
                description: Generate release notes automatically.
                required: false
                default: true
                type: boolean
            make_latest:
                description: Mark release as latest.
                required: false
                default: true
                type: boolean
            allow_updates:
                description: Allow updates to an existing release for the same tag.
                required: false
                default: false
                type: boolean
            verify_manifest_tag:
                description: Ensure tag matches manifest.json version.
                required: false
                default: true
                type: boolean
            previous_tag_name:
                description: Optional previous tag used when generating release notes.
                required: false
                default: ""
                type: string

jobs:
    release-from-tag:
        if: ${{ github.ref_type == 'tag' }}
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Verify and build
              run: |
                  npm run lint
                  npm run build

            - name: Validate version files are consistent
              run: |
                  node -e 'const fs=require("fs"); const read=(f)=>JSON.parse(fs.readFileSync(f,"utf8")); const semver=/^\d+\.\d+\.\d+$/; const versions=[["package.json",read("package.json").version],["manifest.json",read("manifest.json").version],["manifest-beta.json",read("manifest-beta.json").version]]; for (const [name,version] of versions) { if (!semver.test(String(version ?? ""))) { throw new Error(`${name} has invalid version "${version}". Expected x.y.z`); } } const base=String(versions[1][1]); const mismatches=versions.filter(([_,version])=>String(version)!==base); if (mismatches.length>0) { throw new Error(`Version mismatch: ${versions.map(([name,version])=>`${name}=${version}`).join(", ")}`); }'

            - name: Validate tag matches manifest version
              run: |
                  node -e 'const fs=require("fs"); const v=JSON.parse(fs.readFileSync("manifest.json","utf8")).version; const tag=process.env.GITHUB_REF_NAME; if (v !== tag) { throw new Error(`Tag ${tag} does not match manifest version ${v}`); }'

            - name: Create GitHub release with Obsidian assets
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: |
                      manifest.json
                      manifest-beta.json
                      main.js
                      styles.css
                      versions.json

    release-from-call:
        if: ${{ github.ref_type != 'tag' }}
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - name: Use Node.js 20.x
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Verify and build
              run: |
                  npm run lint
                  npm run build

            - name: Validate version files are consistent
              run: |
                  node -e 'const fs=require("fs"); const read=(f)=>JSON.parse(fs.readFileSync(f,"utf8")); const semver=/^\d+\.\d+\.\d+$/; const versions=[["package.json",read("package.json").version],["manifest.json",read("manifest.json").version],["manifest-beta.json",read("manifest-beta.json").version]]; for (const [name,version] of versions) { if (!semver.test(String(version ?? ""))) { throw new Error(`${name} has invalid version "${version}". Expected x.y.z`); } } const base=String(versions[1][1]); const mismatches=versions.filter(([_,version])=>String(version)!==base); if (mismatches.length>0) { throw new Error(`Version mismatch: ${versions.map(([name,version])=>`${name}=${version}`).join(", ")}`); }'

            - name: Validate tag matches manifest version
              if: ${{ inputs.verify_manifest_tag }}
              env:
                  RELEASE_TAG: ${{ inputs.tag_name }}
              run: |
                  node -e 'const fs=require("fs"); const v=JSON.parse(fs.readFileSync("manifest.json","utf8")).version; const tag=process.env.RELEASE_TAG; if (v !== tag) { throw new Error(`Tag ${tag} does not match manifest version ${v}`); }'

            - name: Generate release notes from explicit previous tag
              id: explicit-notes
              if: ${{ inputs.generate_release_notes && inputs.previous_tag_name != '' }}
              uses: actions/github-script@v7
              env:
                  RELEASE_TAG: ${{ inputs.tag_name }}
                  PREVIOUS_TAG: ${{ inputs.previous_tag_name }}
              with:
                  script: |
                      const { data } = await github.rest.repos.generateReleaseNotes({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        tag_name: process.env.RELEASE_TAG,
                        target_commitish: context.sha,
                        previous_tag_name: process.env.PREVIOUS_TAG
                      });
                      core.setOutput("body", data.body);

            - name: Create GitHub release with Obsidian assets
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.tag_name }}
                  name: ${{ inputs.release_name || inputs.tag_name }}
                  prerelease: ${{ inputs.prerelease }}
                  generate_release_notes: ${{ inputs.generate_release_notes && inputs.previous_tag_name == '' }}
                  body: ${{ steps.explicit-notes.outputs.body }}
                  make_latest: ${{ inputs.make_latest }}
                  allow_updates: ${{ inputs.allow_updates }}
                  files: |
                      manifest.json
                      manifest-beta.json
                      main.js
                      styles.css
                      versions.json
